apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-sentinel-config
  namespace: kube-sentinel
  labels:
    app.kubernetes.io/name: kube-sentinel
data:
  config.yaml: |
    loki:
      url: http://loki.monitoring.svc.cluster.local:3100
      query: '{namespace=~".+"} |~ "(?i)(error|fatal|panic|exception|fail)"'
      poll_interval: 30s
      lookback: 5m

    kubernetes:
      in_cluster: true

    web:
      listen: ":8080"
      base_path: /kube-sentinel

    remediation:
      enabled: true
      dry_run: false
      max_actions_per_hour: 50
      excluded_namespaces:
        - kube-system
        - kube-public
        - monitoring
        - logging
        - kube-sentinel

    rules_file: /etc/kube-sentinel/rules.yaml

    store:
      type: memory

  rules.yaml: |
    rules:
      # P1 - Critical errors requiring immediate attention
      - name: crashloop-backoff
        match:
          pattern: "CrashLoopBackOff|Back-off restarting failed container"
        priority: P1
        remediation:
          action: restart-pod
          cooldown: 5m
        enabled: true

      - name: oom-killed
        match:
          pattern: "OOMKilled|Out of memory|memory cgroup out of memory"
        priority: P1
        remediation:
          action: none
          cooldown: 10m
        enabled: true

      - name: panic
        match:
          pattern: "panic:|runtime error:|fatal error:"
        priority: P1
        remediation:
          action: none
          cooldown: 5m
        enabled: true

      # P2 - High priority errors
      - name: image-pull-error
        match:
          pattern: "ImagePullBackOff|ErrImagePull|failed to pull image"
        priority: P2
        remediation:
          action: none
          cooldown: 5m
        enabled: true

      - name: probe-failed
        match:
          pattern: "Readiness probe failed|Liveness probe failed"
        priority: P2
        remediation:
          action: restart-pod
          cooldown: 3m
        enabled: true

      - name: volume-mount-failed
        match:
          pattern: "Unable to attach or mount|FailedMount"
        priority: P2
        remediation:
          action: none
          cooldown: 5m
        enabled: true

      # P3 - Medium priority errors
      - name: dns-error
        match:
          pattern: "EAI_AGAIN|NXDOMAIN|no such host"
        priority: P3
        remediation:
          action: none
          cooldown: 2m
        enabled: true

      - name: connection-refused
        match:
          pattern: "connection refused|ECONNREFUSED"
        priority: P3
        remediation:
          action: none
          cooldown: 2m
        enabled: true

      - name: timeout-error
        match:
          pattern: "timeout|timed out|deadline exceeded"
        priority: P3
        remediation:
          action: none
          cooldown: 2m
        enabled: true

      # P4 - Low priority / Informational
      - name: generic-error
        match:
          pattern: "error"
        priority: P4
        remediation:
          action: none
          cooldown: 5m
        enabled: true

      # Default catch-all rule - MUST BE LAST
      - name: default
        match:
          pattern: "."
        priority: P4
        remediation:
          action: none
          cooldown: 5m
        enabled: true
